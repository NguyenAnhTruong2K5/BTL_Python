{% extends 'accounts/base.html' %}

{% block title %}Hợp đồng - Quản lý bãi đỗ xe{% endblock %}

{% block content %}
<div class="main container-fluid m-2 border border-danger rounded-3 p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="text-danger">Quản lý hợp đồng</h1>
    <a href="{% url 'contract-create-page' %}" class="btn btn-danger">
        <i class="bi bi-plus-circle"></i> Thêm hợp đồng mới
    </a>
</div>

<div class="card mb-4">
    <div class="card-header bg-danger text-white">
        <h5 class="mb-0">Bộ lọc tìm kiếm</h5>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <label for="searchInput" class="form-label">Tìm kiếm chung</label>
                <input type="text" class="form-control" id="searchInput" placeholder="Biển số xe, CCCD...">
            </div>
            <div class="col-md-3">
                <label for="typeFilter" class="form-label">Loại hợp đồng</label>
                <select class="form-select" id="typeFilter">
                    <option value="">Tất cả</option>
                    <option value="daily">Theo ngày</option>
                    <option value="monthly">Theo tháng</option>
                    <option value="yearly">Theo năm</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="statusFilter" class="form-label">Trạng thái</label>
                <select class="form-select" id="statusFilter">
                    <option value="">Tất cả</option>
                    <option value="active">Đang hoạt động</option>
                    <option value="inactive">Không hoạt động</option>
                    <option value="pending">Đang chờ</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button onclick="resetFilters()" class="btn btn-secondary w-100">
                    <i class="bi bi-arrow-counterclockwise"></i> Reset
                </button>
            </div>
        </div>
    </div>
</div>

<div class="table-responsive rounded-3">
    <table class="table table-striped table-hover" id="contractTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Biển số xe</th>
                <th>Khách hàng</th>
                <th>CCCD</th>
                <th>Loại hợp đồng</th>
                <th>Trạng thái</th>
                <th>Thao tác</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<!-- Phân trang -->
<nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center" id="pagination">
    </ul>
</nav>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPage = 1;

// Fetch contracts and populate table
async function loadContracts(page = 1) {
    try {
        showLoading();
        const searchTerm = document.getElementById('searchInput').value;
        const type = document.getElementById('typeFilter').value;
        const status = document.getElementById('statusFilter').value;
        
        let url = `/api/accounts/contracts/?page=${page}`;
        if (searchTerm) url += `&search=${searchTerm}`;
        if (type) url += `&type=${type}`;
        if (status) url += `&status=${status}`;
        
        const response = await fetch(url);
        const data = await response.json();
        const tbody = document.querySelector('#contractTable tbody');
        tbody.innerHTML = '';
        
        data.results.forEach(contract => {
            const row = `
                <tr>
                    <td>${contract.id}</td>
                    <td>${contract.plate_number}</td>
                    <td>${contract.cccd.name}</td>
                    <td>${contract.cccd.cccd}</td>
                    <td>
                        <span class="badge ${getTypeClass(contract.type)}">
                            ${getTypeLabel(contract.type)}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${getStatusClass(contract.status)}">
                            ${getStatusLabel(contract.status)}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group">
                            <a href="/accounts/contracts/${contract.id}/edit/" class="btn btn-sm btn-warning">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <button onclick="deleteContract('${contract.id}')" class="btn btn-sm btn-danger">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
            tbody.insertAdjacentHTML('beforeend', row);
        });

        // Update pagination
        updatePagination(data);
        
        hideLoading();
    } catch (error) {
        console.error('Error loading contracts:', error);
        hideLoading();
        showToast('error', 'Lỗi khi tải danh sách hợp đồng');
    }
}

function getTypeLabel(type) {
    const labels = {
        'daily': 'Theo ngày',
        'monthly': 'Theo tháng',
        'yearly': 'Theo năm'
    };
    return labels[type] || type;
}

function getTypeClass(type) {
    const classes = {
        'daily': 'bg-info',
        'monthly': 'bg-primary',
        'yearly': 'bg-success'
    };
    return classes[type] || 'bg-secondary';
}

function getStatusLabel(status) {
    const labels = {
        'active': 'Đang hoạt động',
        'inactive': 'Không hoạt động',
        'pending': 'Đang chờ'
    };
    return labels[status] || status;
}

function getStatusClass(status) {
    const classes = {
        'active': 'bg-success',
        'inactive': 'bg-danger',
        'pending': 'bg-warning'
    };
    return classes[status] || 'bg-secondary';
}

function updatePagination(data) {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    if (data.count > 0) {
        const totalPages = Math.ceil(data.count / 10);
        
        // Previous button
        pagination.innerHTML += `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">
                    <i class="bi bi-chevron-left"></i>
                </a>
            </li>`;
        
        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                pagination.innerHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>`;
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                pagination.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }
        
        // Next button
        pagination.innerHTML += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </li>`;
    }
}

function changePage(page) {
    if (page < 1) return;
    currentPage = page;
    loadContracts(page);
}

// Delete contract
async function deleteContract(id) {
    if (confirm('Bạn có chắc chắn muốn xóa hợp đồng này?')) {
        try {
            showLoading();
            const response = await fetch(`/api/accounts/contracts/${id}/delete/`, {
                method: 'DELETE'
            });
            if (response.ok) {
                showToast('success', 'Xóa hợp đồng thành công');
                await loadContracts(currentPage);
            } else {
                showToast('error', 'Lỗi khi xóa hợp đồng');
            }
            hideLoading();
        } catch (error) {
            console.error('Error deleting contract:', error);
            hideLoading();
            showToast('error', 'Lỗi khi xóa hợp đồng');
        }
    }
}

// Filter handling
function resetFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('typeFilter').value = '';
    document.getElementById('statusFilter').value = '';
    currentPage = 1;
    loadContracts(1);
}

// Event listeners
document.getElementById('searchInput').addEventListener('input', debounce(() => {
    currentPage = 1;
    loadContracts(1);
}, 300));

document.getElementById('typeFilter').addEventListener('change', () => {
    currentPage = 1;
    loadContracts(1);
});

document.getElementById('statusFilter').addEventListener('change', () => {
    currentPage = 1;
    loadContracts(1);
});

// Debounce function
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Load contracts on page load
document.addEventListener('DOMContentLoaded', () => loadContracts(1));
</script>
{% endblock %}