{% extends 'accounts/base.html' %}

{% block title %}Customers - Parking Management{% endblock %}

{% block content %}
<div class="main container-fluid m-2 border border-danger rounded-3 p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="text-danger">Customers</h1>
    <a href="{% url 'customer-create-page' %}" class="btn btn-danger"><i class="bi bi-plus-circle"></i> Add Customer</a>
</div>

<div class="mb-3">
    <input type="text" class="form-control" id="searchInput" placeholder="Search customers...">
</div>

<div class="table-responsive rounded-3">
    <table class="table" id="customerTable">
        <thead>
            <tr>
                <th>CCCD</th>
                <th>Name</th>
                <th>Phone</th>
                <th>Email</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<!-- Edit Customer Modal -->
<div class="modal fade" id="editCustomerModal" tabindex="-1" aria-labelledby="editCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCustomerModalLabel">Edit Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editCustomerForm">
                    <input type="hidden" id="editCustomerCccd">
                    <div class="mb-3">
                        <label for="editCustomerName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="editCustomerName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editCustomerPhone" class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="editCustomerPhone" required>
                    </div>
                    <div class="mb-3">
                        <label for="editCustomerEmail" class="form-label">Email (Optional)</label>
                        <input type="email" class="form-control" id="editCustomerEmail">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveCustomerChanges()">Save changes</button>
            </div>
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Fetch customers and populate table
async function loadCustomers() {
    try {
        const response = await fetch('/api/accounts/customers/');
        const data = await response.json();
        const tbody = document.querySelector('#customerTable tbody');
        tbody.innerHTML = '';
        
        data.results.forEach(customer => {
            const row = `
                <tr>
                    <td>${customer.cccd}</td>
                    <td>${customer.name}</td>
                    <td>${customer.phone_number}</td>
                    <td>${customer.email || '-'}</td>
                    <td>
                        <button onclick="editCustomer('${customer.cccd}', '${customer.name}', '${customer.phone_number}', '${customer.email || ''}')" 
                                class="btn btn-sm btn-warning">Edit</button>
                        <button onclick="deleteCustomer('${customer.cccd}')" 
                                class="btn btn-sm btn-danger">Delete</button>
                    </td>
                </tr>`;
            tbody.insertAdjacentHTML('beforeend', row);
        });
    } catch (error) {
        console.error('Error loading customers:', error);
    }
}

// Delete customer
async function deleteCustomer(cccd) {
    if (confirm('Are you sure you want to delete this customer?')) {
        try {
            const response = await fetch(`/api/accounts/customers/${cccd}/delete/`, {
                method: 'DELETE'
            });
            if (response.ok) {
                loadCustomers();
            }
        } catch (error) {
            console.error('Error deleting customer:', error);
        }
    }
}

// Search functionality
document.getElementById('searchInput').addEventListener('input', async function(e) {
    const searchTerm = e.target.value;
    if (searchTerm) {
        const response = await fetch(`/api/accounts/customers/search/?search=${searchTerm}`);
        const data = await response.json();
        updateTable(data.results);
    } else {
        loadCustomers();
    }
});

function updateTable(customers) {
    const tbody = document.querySelector('#customerTable tbody');
    tbody.innerHTML = '';
    customers.forEach(customer => {
        const row = `
            <tr>
                <td>${customer.cccd}</td>
                <td>${customer.name}</td>
                <td>${customer.phone_number}</td>
                <td>
                    <a href="/customers/${customer.cccd}/edit/" class="btn btn-sm btn-warning">Edit</a>
                    <button onclick="deleteCustomer('${customer.cccd}')" class="btn btn-sm btn-danger">Delete</button>
                </td>
            </tr>`;
        tbody.insertAdjacentHTML('beforeend', row);
    });
}

// Edit customer
function editCustomer(cccd, name, phone, email) {
    // Populate modal form with customer data
    document.getElementById('editCustomerCccd').value = cccd;
    document.getElementById('editCustomerName').value = name;
    document.getElementById('editCustomerPhone').value = phone;
    document.getElementById('editCustomerEmail').value = email;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('editCustomerModal'));
    modal.show();
}

// Save customer changes
async function saveCustomerChanges() {
    const cccd = document.getElementById('editCustomerCccd').value;
    const formData = {
        cccd: document.getElementById('editCustomerCccd').value,
        name: document.getElementById('editCustomerName').value,
        phone_number: document.getElementById('editCustomerPhone').value,
        email: document.getElementById('editCustomerEmail').value || null
    };
    
    try {
        const response = await fetch(`/api/accounts/customers/${cccd}/update/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editCustomerModal'));
            modal.hide();
            
            // Reload customer list
            loadCustomers();
            
            // Show success message
            alert('Customer updated successfully!');
        } else {
            const data = await response.json();
            alert('Error updating customer: ' + JSON.stringify(data));
        }
    } catch (error) {
        console.error('Error updating customer:', error);
        alert('Error updating customer. Please try again.');
    }
}

// Load customers on page load
document.addEventListener('DOMContentLoaded', loadCustomers);
</script>
{% endblock %}